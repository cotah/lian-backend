<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALTRIX - LIAN Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Floating Launcher Button */
        #lian-launcher {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 130px;
            height: 130px;
            cursor: pointer;
            z-index: 9999;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #lian-launcher:hover {
            transform: scale(1.1);
        }

        #lian-launcher.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0);
        }

        /* Chatbot Container */
        #lian-chatbot {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 420px;
            height: 730px;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            z-index: 10000;
            overflow: hidden;
        }

        #lian-chatbot.active {
            display: flex;
        }

        /* Header */
        #lian-header {
            background: linear-gradient(135deg, #ff8a00 0%, #e52e71 100%);
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #lian-header h2 {
            font-size: 22px;
            font-weight: 600;
        }

        #lian-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
        }

        #lian-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Messages Area */
        #lian-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #ff8a00 0%, #e52e71 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        /* Voice Panel */
        #lian-voice-panel {
            background: #2d2d2d;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            max-height: 300px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        #lian-voice-panel.collapsed {
            max-height: 0;
            padding: 0;
        }

        /* Video Avatar */
        #lian-avatar-video {
            width: 175px;
            height: 175px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #ff8a00;
            box-shadow: 0 5px 20px rgba(255, 138, 0, 0.3);
        }

        /* Status Indicator */
        #lian-status {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        #lian-status.active {
            display: block;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Voice Toggle Button */
        #lian-voice-toggle {
            background: linear-gradient(135deg, #ff8a00 0%, #e52e71 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        #lian-voice-toggle:hover {
            transform: scale(1.05);
        }

        /* Input Area */
        #lian-input-area {
            padding: 15px 20px 3px 20px;
            background: white;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
            border-top: 1px solid #ddd;
        }

        #lian-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 12px 18px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #lian-input:focus {
            border-color: #ff8a00;
        }

        #lian-send {
            background: linear-gradient(135deg, #ff8a00 0%, #e52e71 100%);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
        }

        #lian-send:hover {
            transform: scale(1.1);
        }

        /* Footer */
        #lian-footer {
            background: white;
            padding: 3px;
            text-align: center;
            font-size: 11px;
            color: #999;
            flex-shrink: 0;
        }

        #lian-footer a {
            color: #ff8a00;
            text-decoration: none;
            font-weight: 600;
        }

        /* Scrollbar */
        #lian-messages::-webkit-scrollbar {
            width: 6px;
        }

        #lian-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #lian-messages::-webkit-scrollbar-thumb {
            background: #ff8a00;
            border-radius: 3px;
        }

        /* Mobile Responsive */
        @media (max-width: 480px) {
            #lian-chatbot {
                width: 100%;
                height: 100%;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }

            #lian-launcher {
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body>

    <!-- Floating Launcher Button -->
    <img id="lian-launcher" src="lian-bot.png" alt="Open Lian Chat">

    <!-- Chatbot Container -->
    <div id="lian-chatbot">
        <!-- Header -->
        <div id="lian-header">
            <h2>ALTRIX - LIAN</h2>
            <button id="lian-close">&times;</button>
        </div>

        <!-- Messages Area -->
        <div id="lian-messages"></div>

        <!-- Voice Panel -->
        <div id="lian-voice-panel">
            <video id="lian-avatar-video" loop muted playsinline>
                <source src="lian-talking.mp4" type="video/mp4">
            </video>
            <div id="lian-status">Lian is speaking...</div>
            <button id="lian-voice-toggle">ðŸŽ¤ Voice Chat</button>
        </div>

        <!-- Input Area -->
        <div id="lian-input-area">
            <input type="text" id="lian-input" placeholder="Type your message...">
            <button id="lian-send">âž¤</button>
        </div>

        <!-- Footer -->
        <div id="lian-footer">
            Powered by <a href="https://btrix.ai" target="_blank">BTRIX AI</a>
        </div>
    </div>

    <script>
        // DOM Elements
        const launcher = document.getElementById('lian-launcher');
        const chatbot = document.getElementById('lian-chatbot');
        const closeBtn = document.getElementById('lian-close');
        const messagesDiv = document.getElementById('lian-messages');
        const inputField = document.getElementById('lian-input');
        const sendBtn = document.getElementById('lian-send');
        const voicePanel = document.getElementById('lian-voice-panel');
        const voiceToggle = document.getElementById('lian-voice-toggle');
        const statusDiv = document.getElementById('lian-status');
        const avatarVideo = document.getElementById('lian-avatar-video');

        // State
        let isListening = false;
        let recognition = null;
        let currentAudio = null;

        // Backend URL
        const BACKEND_URL = 'https://lian-backend.vercel.app';

        // Open chatbot
        launcher.addEventListener('click', () => {
            chatbot.classList.add('active');
            launcher.classList.add('hidden');
            addMessage('bot', 'Hello! I\'m Lian, your virtual assistant. How can I help you today?');
        });

        // Close chatbot
        closeBtn.addEventListener('click', () => {
            chatbot.classList.remove('active');
            launcher.classList.remove('hidden');
        });

        // Toggle voice panel
        voiceToggle.addEventListener('click', () => {
            voicePanel.classList.toggle('collapsed');
        });

        // Send message
        sendBtn.addEventListener('click', sendMessage);
        inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Add message to chat
        function addMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;
            
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Send message function
        async function sendMessage() {
            const message = inputField.value.trim();
            if (!message) return;

            // Add user message
            addMessage('user', message);
            inputField.value = '';

            try {
                // Get response from backend
                const response = await fetch(`${BACKEND_URL}/api/lian`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                const botReply = data.reply || 'Sorry, I couldn\'t process that.';

                // Get TTS audio
                const ttsResponse = await fetch(`${BACKEND_URL}/api/lian-tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: botReply })
                });

                const ttsData = await ttsResponse.json();

                // SYNCHRONIZED PLAYBACK: Text + Audio + Video together!
                if (ttsData.audio) {
                    // Create audio element
                    const audio = new Audio(`data:audio/mp3;base64,${ttsData.audio}`);
                    currentAudio = audio;

                    // Wait for both audio and video to be ready
                    await Promise.all([
                        new Promise(resolve => audio.addEventListener('canplaythrough', resolve, { once: true })),
                        avatarVideo.readyState >= 3 ? Promise.resolve() : new Promise(resolve => {
                            avatarVideo.addEventListener('canplaythrough', resolve, { once: true });
                        })
                    ]);

                    // Start everything at the same time!
                    await Promise.all([
                        addMessage('bot', botReply), // Add text
                        playAudioAndVideo(audio)      // Play audio + video
                    ]);

                } else {
                    // Fallback: just text
                    addMessage('bot', botReply);
                }

            } catch (error) {
                console.error('Error:', error);
                addMessage('bot', 'Sorry, something went wrong. Please try again.');
            }
        }

        // Play audio and video synchronized
        async function playAudioAndVideo(audio) {
            return new Promise((resolve) => {
                // Show status
                statusDiv.classList.add('active');

                // Start video
                avatarVideo.currentTime = 0;
                const videoPromise = avatarVideo.play();

                // Start audio
                const audioPromise = audio.play();

                // Wait for both to start
                Promise.all([videoPromise, audioPromise]).catch(err => {
                    console.error('Playback error:', err);
                });

                // When audio ends
                audio.addEventListener('ended', () => {
                    // Stop video
                    avatarVideo.pause();
                    avatarVideo.currentTime = 0;
                    
                    // Hide status
                    statusDiv.classList.remove('active');
                    
                    resolve();
                }, { once: true });
            });
        }

        // Voice Recognition (Web Speech API)
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                inputField.value = transcript;
                sendMessage();
                isListening = false;
                voiceToggle.textContent = 'ðŸŽ¤ Voice Chat';
            };

            recognition.onerror = () => {
                isListening = false;
                voiceToggle.textContent = 'ðŸŽ¤ Voice Chat';
            };

            recognition.onend = () => {
                isListening = false;
                voiceToggle.textContent = 'ðŸŽ¤ Voice Chat';
            };

            voiceToggle.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                    isListening = false;
                    voiceToggle.textContent = 'ðŸŽ¤ Voice Chat';
                } else {
                    recognition.start();
                    isListening = true;
                    voiceToggle.textContent = 'ðŸ”´ Listening...';
                }
            });
        } else {
            voiceToggle.style.display = 'none';
        }

        // Preload video
        avatarVideo.load();
    </script>

</body>
</html>